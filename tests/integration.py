import subprocess, os, tempfile, json, glob, shutil, datetime, numpy, gsw, scipy.interpolate, scipy.io, copy
import pandas as pd

def test_argovis_pipeline():
    tmpdir = tempfile.mkdtemp(prefix="test_data_dir_")

    try:
        input_path = os.path.join(tmpdir, "2025-05.json")
        profile = {"_id":"1902305_128","geolocation":{"type":"Point","coordinates":[-27.4493,2.32012]},"basin":1,"timestamp":"2025-05-13T04:18:41.000Z","date_updated_argovis":"2025-05-13T06:45:52.923Z","source":[{"source":["argo_core"],"url":"ftp://ftp.ifremer.fr/ifremer/argo/dac/aoml/1902305/profiles/R1902305_128.nc","date_updated":"2025-05-13T05:01:55.000Z"}],"cycle_number":128,"geolocation_argoqc":1,"profile_direction":"A","timestamp_argoqc":1,"vertical_sampling_scheme":"Primary sampling: averaged [nominal 2 dbar binned data sampled at 0.5 Hz from a SBE41CP]","data":[[28.973,29.006001,29.028999,29.062,29.112,29.176001,29.281,29.327999,29.313999,29.291,29.245001,29.224001,29.209,29.200001,29.193001,29.188999,29.181,29.177999,29.172001,29.167999,29.162001,29.152,29.110001,29.077,29.045,29.002001,28.964001,28.865999,28.184999,25.281,23.677999,21.349001,19.408001,18.635,17.73,17.316,16.955999,16.646999,16.615999,16.580999,16.51,16.440001,16.386,16.368,16.25,16.145,16.136,16.125999,16.118,16.105,16.066,15.973,15.923,15.85,15.751,15.663,15.611,15.526,15.435,15.321,15.216,15.161,15.11,15.006,14.922,14.915,14.916,14.915,14.914,14.911,14.905,14.892,14.829,14.774,14.717,14.684,14.667,14.615,14.526,14.479,14.436,14.402,14.389,14.366,14.316,14.272,14.229,14.191,14.167,14.155,14.15,14.116,14.099,14.096,14.096,14.096,14.093,14.076,14.056,14.036,14,13.961,13.939,13.913,13.899,13.878,13.855,13.81,13.775,13.748,13.691,13.657,13.638,13.611,13.587,13.582,13.567,13.551,13.537,13.535,13.533,13.519,13.486,13.471,13.46,13.449,13.432,13.426,13.426,13.417,13.383,13.357,13.328,13.3,13.268,13.18,13.105,13.065,13.019,13.007,12.995,12.978,12.974,12.968,12.961,12.933,12.833,12.725,12.674,12.623,12.584,12.569,12.553,12.525,12.488,12.408,12.379,12.339,12.308,12.153,12.017,11.918,11.831,11.799,11.781,11.77,11.759,11.746,11.68,11.619,11.566,11.499,11.477,11.428,11.353,11.251,11.151,11.08,10.965,10.825,10.763,10.712,10.582,10.467,10.417,10.363,10.338,10.248,10.204,10.166,10.144,10.08,10.039,10.005,9.972,9.902,9.808,9.723,9.669,9.625,9.593,9.542,9.502,9.462,9.351,9.306,9.25,9.197,9.17,9.146,9.116,9.067,9.014,8.995,8.971,8.906,8.869,8.834,8.806,8.788,8.752,8.657,8.616,8.617,8.632,8.638,8.64,8.606,8.578,8.56,8.518,8.444,8.416,8.369,8.286,8.227,8.185,8.154,8.104,8.056,8.013,7.946,7.883,7.82,7.741,7.72,7.734,7.74,7.743,7.738,7.678,7.592,7.569,7.563,7.544,7.532,7.512,7.479,7.418,7.347,7.309,7.305,7.302,7.282,7.254,7.221,7.186,7.157,7.147,7.143,7.14,7.128,7.06,7.019,7.009,7.006,6.996,6.947,6.936,6.932,6.902,6.839,6.79,6.743,6.733,6.716,6.704,6.685,6.671,6.667,6.641,6.626,6.599,6.591,6.578,6.562,6.549,6.538,6.532,6.529,6.528,6.519,6.512,6.486,6.461,6.419,6.391,6.383,6.368,6.363,6.365,6.369,6.365,6.325,6.287,6.26,6.251,6.23,6.211,6.206,6.203,6.199,6.187,6.16,6.152,6.141,6.14,6.124,6.104,6.101,6.097,6.059,6.04,6.039,6.039,6.032,6.018,5.993,5.942,5.895,5.868,5.858,5.844,5.853,5.876,5.841,5.791,5.76,5.738,5.719,5.655,5.638,5.622,5.613,5.61,5.602,5.597,5.6,5.593,5.57,5.544,5.504,5.488,5.488,5.486,5.482,5.478,5.478,5.46,5.443,5.435,5.429,5.427,5.427,5.428,5.421,5.413,5.403,5.413,5.416,5.426,5.439,5.418,5.407,5.412,5.413,5.409,5.415,5.414,5.416,5.426,5.434,5.425,5.391,5.367,5.358,5.349,5.347,5.339,5.319,5.3,5.287,5.28,5.279,5.277,5.275,5.272,5.269,5.267,5.264,5.264,5.258,5.255,5.251,5.245,5.221,5.183,5.132,5.131,5.122,5.101,5.087,5.085,5.059,5.081,5.102,5.102,5.092,5.08,5.078,5.074,5.071,5.063,5.057,5.049,5.044,5.039,5.023,5.016,5.011,5.007,5.006,5.002,4.998,4.99,4.969,4.944,4.913,4.897,4.886,4.881,4.878,4.874,4.869,4.865,4.851,4.845,4.84,4.838,4.835,4.834,4.835,4.836,4.837,4.837,4.836,4.836,4.826,4.82,4.804,4.8,4.807,4.809,4.798,4.785,4.781,4.781,4.779,4.782,4.795,4.797,4.79,4.764,4.762,4.766,4.768,4.766,4.763,4.759,4.759,4.761,4.76,4.757,4.753,4.745,4.742,4.743,4.744,4.747,4.747,4.747,4.746,4.744,4.744,4.745,4.746,4.75,4.76,4.764,4.764,4.76,4.751,4.752,4.754,4.753,4.754,4.76,4.764,4.765,4.763,4.764,4.762,4.756,4.753,4.75,4.746,4.747,4.75,4.75,4.749,4.748,4.745,4.745,4.745,4.749,4.761,4.768,4.772,4.774,4.775,4.778,4.775,4.772,4.771,4.77,4.766,4.761,4.759,4.76,4.761,4.768,4.772,4.772,4.769,4.775,4.778,4.775,4.767,4.764,4.761,4.759,4.759,4.759,4.755,4.747,4.747,4.749,4.744,4.726,4.714,4.709,4.703,4.701,4.7,4.698,4.696,4.696,4.697,4.699,4.702,4.705,4.706,4.703,4.701,4.694,4.691,4.685,4.68,4.678,4.677,4.676,4.673,4.669,4.667,4.666,4.665,4.663,4.662,4.661,4.661,4.662,4.664,4.665,4.665,4.667,4.668,4.67,4.671,4.671,4.671,4.673,4.674,4.675,4.676,4.676,4.677,4.677,4.676,4.671,4.668,4.667,4.667,4.667,4.666,4.666,4.665,4.66,4.653,4.652,4.651,4.65,4.647,4.645,4.644,4.643,4.642,4.638,4.632,4.625,4.619,4.616,4.615,4.614,4.611,4.608,4.601,4.598,4.598,4.598,4.598,4.598,4.598,4.599,4.6,4.598,4.597,4.595,4.594,4.587,4.583,4.583,4.578,4.564,4.556,4.553,4.545,4.527,4.523,4.519,4.517,4.512,4.511,4.504,4.491,4.476,4.466,4.455,4.452,4.452,4.452,4.451,4.447,4.442,4.437,4.437,4.435,4.431,4.429,4.427,4.423,4.42,4.42,4.417,4.415,4.415,4.415,4.417,4.415,4.416,4.415,4.417,4.42,4.425,4.419,4.4,4.393,4.386,4.384,4.383,4.382,4.379,4.38,4.385,4.385,4.375,4.373,4.379,4.376,4.368,4.365,4.364,4.364,4.364,4.36,4.354,4.351,4.351,4.347,4.352,4.351,4.347,4.344,4.335,4.332,4.332,4.331,4.33,4.332,4.337,4.338,4.333,4.323,4.314,4.299,4.29,4.29,4.289,4.288,4.289,4.287,4.288,4.29,4.277,4.269,4.263,4.263,4.262,4.261,4.253,4.25,4.248,4.242,4.235,4.231,4.23,4.229,4.228,4.227,4.225,4.225,4.224,4.224,4.224,4.223,4.221,4.219,4.218,4.216,4.215,4.213,4.211,4.208,4.204,4.204,4.204,4.204,4.197,4.191,4.192,4.193,4.19,4.182,4.177,4.173,4.168,4.163,4.162,4.161,4.16,4.152,4.149,4.146,4.144,4.14,4.139,4.136,4.132,4.131,4.127,4.122,4.119,4.118,4.117,4.116,4.116,4.115,4.115,4.111,4.105,4.097,4.093,4.09,4.085,4.083,4.081,4.077,4.077,4.076,4.074,4.071,4.07,4.069,4.06,4.055,4.052,4.05,4.047,4.045,4.044,4.037,4.036,4.034,4.032,4.03,4.027,4.026,4.025,4.023,4.017,4.013,4.01,4.008,4.006,4.005,4.005,4.004,4.003,4.001,3.998,3.996,3.995,3.995,3.996,3.996,3.996,3.993,3.978,3.96,3.952,3.944,3.94,3.945,3.946,3.945,3.932,3.92,3.91,3.91,3.91,3.909,3.906,3.901,3.897,3.898,3.899,3.9,3.901,3.901,3.898,3.894,3.892,3.89,3.887,3.883,3.877,3.872,3.87,3.869,3.868,3.867,3.866,3.867,3.867,3.867,3.867,3.866,3.866,3.861,3.858,3.854,3.851,3.846,3.845,3.842,3.839,3.839,3.838,3.837,3.831,3.828,3.828,3.828,3.828,3.828,3.827,3.826,3.826,3.825,3.823,3.822,3.821,3.819,3.818,3.816,3.816,3.814,3.812,3.809,3.807,3.807,3.806,3.803,3.798,3.793,3.787,3.784,3.783,3.782,3.78,3.776,3.77,3.76,3.757,3.754,3.748,3.746,3.74,3.724,3.72,3.718,3.717,3.717,3.716,3.716,3.716,3.713,3.708,3.703,3.696,3.688,3.683,3.681,3.68,3.679,3.678,3.678,3.675,3.675,3.675,3.674,3.673,3.671,3.665,3.662,3.661,3.66,3.656,3.653,3.652,3.651,3.648,3.642,3.637,3.631,3.63,3.627,3.624,3.622,3.619,3.615,3.609,3.608,3.608,3.602,3.589,3.588,3.588,3.588],[1.04,1.96,3,4.04,5.08,5.96,6.92,8.04,8.96,10.24,11.96,13.92,15.96,18,20,22,24.040001,26.040001,28,30,32.040001,34.040001,36.040001,38,39.959999,41.959999,44,45.959999,47.959999,50.16,51.919998,53.880001,56,58,60.040001,62.040001,64.040001,66,67.959999,69.959999,71.919998,73.959999,76,78,80,81.959999,83.959999,86.040001,88,90.040001,92,94,96,97.959999,100,102,103.959999,105.919998,107.959999,110,112.040001,114,115.919998,117.959999,120.040001,122.040001,124,126.040001,128.039993,130,132,134.039993,136.039993,138,139.960007,141.960007,144.039993,146.080002,148.039993,150.039993,152.119995,154,155.919998,157.960007,159.960007,161.960007,164,166,167.960007,170,172.039993,174,176,178,180,181.960007,184,186,187.960007,190.039993,192,194,196,198,199.960007,202,204.039993,205.960007,208,210.039993,212,213.960007,216,217.960007,219.960007,221.960007,224,226.039993,228.039993,229.960007,231.919998,233.919998,235.960007,238.039993,240.039993,242,244,246,248,249.960007,251.960007,254.039993,256.040009,258,259.959991,262,264,265.959991,267.959991,270,271.920013,273.920013,275.959991,277.959991,280,282,283.959991,285.959991,287.959991,289.959991,291.959991,293.959991,295.959991,298.040009,300.040009,301.920013,303.959991,306,307.959991,310,312,314,316,317.959991,319.959991,321.959991,324.040009,326,328,330.040009,332.079987,334.079987,336.040009,337.959991,340,342.040009,344,346,348,350,351.959991,353.959991,355.959991,357.959991,359.959991,361.959991,363.959991,366,367.959991,369.959991,371.959991,373.959991,375.920013,377.959991,380,382,383.959991,385.959991,387.959991,389.959991,391.959991,394,395.959991,398,400.040009,402,403.959991,406,408,409.959991,412,414,415.959991,418,420.040009,422.040009,424.040009,426,427.959991,429.959991,431.959991,434,435.920013,437.920013,439.959991,441.920013,443.959991,446,447.920013,449.920013,451.959991,453.959991,455.959991,458,460.040009,462,464,466,468,470,472,474.040009,476,477.959991,480.040009,482.040009,484,486,487.959991,489.920013,491.959991,494,496,497.959991,499.959991,501.959991,503.959991,505.959991,508,510.040009,512,514,516.039978,518,520.039978,522,523.960022,526,528.039978,530,532,534.039978,536.039978,538.039978,540,541.960022,543.960022,546,547.960022,549.919983,551.919983,554,556.039978,558.039978,559.960022,561.960022,564,566,568,569.960022,572,574,575.919983,577.960022,579.960022,581.960022,584,586,588,590,592,594,596,598.039978,600.039978,601.960022,604,606,608.039978,609.960022,612,614.039978,616,617.960022,619.919983,622,624,625.960022,628,630.039978,632.039978,634,636,638,640,642,644,646,648.039978,650.039978,652,653.960022,656,658.039978,659.960022,662,664.039978,666.039978,668,670,672,674,675.960022,678,680,682.039978,684,685.960022,687.960022,689.960022,691.960022,694,695.960022,697.919983,699.960022,702,704,706,708,709.960022,712,714.039978,716,717.960022,719.960022,721.960022,723.960022,725.960022,727.960022,730,732,734,735.960022,738,740.039978,741.960022,744,746,747.960022,749.960022,751.960022,754,756,758.039978,760.039978,761.960022,763.960022,766,768,770.039978,772,774,776.039978,778,780,781.960022,784,786.039978,788,790.039978,791.960022,793.960022,795.960022,797.960022,800.039978,802.039978,804,806,808.039978,810,811.960022,814,816.039978,818,820,821.960022,823.960022,825.960022,827.960022,830,832,834,835.960022,838,839.960022,841.960022,843.919983,845.960022,848,850.039978,852.039978,854.080017,856.039978,858,860.039978,862,863.960022,866,868,870.039978,872.039978,874,875.960022,877.960022,879.960022,881.960022,883.960022,886,888.039978,890,892,894.039978,896,898.039978,900.080017,902,903.960022,905.960022,908,910,912.039978,914,916,918.039978,920,922.039978,924,926,928,930,931.960022,934,936,937.960022,939.960022,942.039978,944.080017,946.080017,948.039978,949.960022,951.960022,953.960022,955.960022,958.039978,960.039978,961.960022,963.919983,965.960022,968,969.960022,971.960022,973.960022,975.960022,978,980.039978,982,983.960022,985.960022,987.919983,989.919983,991.960022,994,995.960022,997.919983,1000,1002,1004,1006,1008.039978,1009.960022,1011.919983,1013.919983,1016,1018.080017,1020.080017,1022.039978,1024,1026,1028.040039,1030.040039,1032,1034,1036,1037.920044,1039.920044,1041.920044,1044,1046.040039,1047.920044,1049.959961,1051.959961,1053.959961,1055.959961,1058.040039,1060,1062,1063.959961,1065.959961,1068.040039,1070,1072,1074,1075.959961,1078,1080,1082.040039,1084.040039,1086.040039,1088,1089.959961,1091.959961,1093.959961,1095.959961,1097.959961,1099.959961,1102,1104.079956,1106,1108,1109.959961,1111.959961,1114,1116,1118,1119.959961,1121.959961,1124,1126,1127.959961,1129.959961,1131.959961,1134,1136,1138,1140.040039,1142,1144,1146,1148,1149.959961,1151.959961,1154,1156,1158,1160.040039,1162,1164.040039,1166,1167.959961,1169.959961,1171.920044,1173.959961,1176,1178,1180,1182,1184.040039,1186,1188.040039,1190.040039,1192.040039,1193.959961,1195.959961,1198.040039,1200,1201.920044,1203.959961,1206,1208,1210,1212,1213.959961,1215.959961,1218,1219.959961,1221.920044,1224,1226.040039,1228,1230,1232.040039,1234.079956,1236,1237.920044,1240,1241.959961,1243.959961,1245.959961,1247.959961,1250.040039,1251.959961,1254,1256,1257.959961,1259.959961,1262,1264,1266.040039,1268,1269.920044,1272,1274.040039,1275.959961,1277.959961,1280.040039,1282.040039,1284,1286.040039,1288,1289.959961,1291.959961,1293.959961,1295.920044,1297.959961,1300.040039,1302.040039,1303.959961,1305.959961,1308,1310,1312,1314,1315.959961,1318,1320,1322.040039,1324,1326,1328,1330.040039,1332.040039,1333.959961,1335.959961,1337.959961,1339.959961,1342,1344.040039,1346,1347.959961,1350,1352,1354.040039,1356.040039,1357.959961,1359.959961,1361.959961,1363.959961,1366,1367.959961,1370.040039,1372.079956,1374,1376,1378,1379.920044,1381.959961,1384,1386,1387.920044,1390,1392.040039,1394.079956,1396.040039,1398,1400,1401.959961,1404,1406.040039,1408.040039,1410,1412,1414.040039,1416,1418,1419.959961,1421.959961,1424.040039,1426,1428,1430,1432,1434,1435.959961,1437.959961,1440,1441.959961,1443.959961,1446,1448.040039,1450.040039,1452,1454,1456,1458,1460,1462,1464,1466,1468,1470,1472.040039,1474,1475.959961,1478.040039,1480.040039,1481.959961,1483.920044,1486,1488,1490,1491.959961,1493.959961,1496,1498,1500.040039,1502.040039,1504,1506,1508,1509.959961,1512,1514.040039,1516.040039,1518.040039,1519.959961,1522,1524,1526,1527.959961,1529.920044,1532,1534.040039,1536,1538.040039,1540,1541.959961,1543.959961,1545.959961,1548.040039,1550.040039,1552,1554,1556,1558,1559.959961,1562,1564.040039,1566,1567.959961,1570,1572.040039,1574.040039,1576,1577.959961,1580,1581.959961,1583.959961,1586,1588,1590,1592.040039,1594,1596,1598.040039,1600,1602,1604,1606.040039,1608.040039,1610,1611.959961,1613.959961,1615.959961,1618,1619.959961,1621.959961,1623.959961,1625.959961,1628,1630,1632.040039,1633.959961,1636,1637.959961,1639.959961,1642,1644,1646,1648,1649.959961,1651.959961,1653.959961,1656,1657.959961,1659.959961,1662.040039,1664.040039,1666,1668.040039,1670.040039,1672,1674.040039,1676.040039,1678,1680,1682,1683.959961,1685.959961,1687.959961,1689.959961,1692,1694.040039,1696.079956,1698,1699.959961,1701.959961,1703.920044,1705.959961,1708,1709.959961,1711.959961,1713.959961,1716,1718,1720,1722.040039,1724,1725.920044,1727.920044,1729.959961,1731.959961,1734,1736.040039,1738.040039,1739.959961,1741.959961,1743.959961,1746,1748.040039,1750,1752,1754,1755.959961,1757.959961,1759.959961,1761.959961,1764,1766.040039,1768.040039,1770,1772,1773.959961,1775.959961,1778,1780.040039,1782,1784,1786.040039,1788.040039,1790.040039,1792.040039,1794,1796,1797.959961,1799.959961,1801.920044,1803.959961,1805.959961,1807.959961,1809.959961,1812,1814.040039,1816,1818,1820,1822,1824,1826,1828.040039,1830.040039,1832,1834,1835.959961,1838,1840.040039,1842,1843.959961,1846,1848,1849.959961,1852,1854.040039,1856.040039,1858.040039,1860.079956,1862,1863.959961,1865.959961,1867.959961,1869.920044,1871.959961,1874,1876,1878,1880,1882,1883.959961,1886,1888.040039,1890,1891.959961,1893.959961,1895.959961,1898.040039,1900.040039,1901.959961,1903.959961,1906,1908,1910.040039,1912,1913.920044,1915.920044,1918,1920,1921.959961,1924,1926.079956,1928.040039,1930.040039,1932.040039,1934,1935.959961,1938,1940,1942.040039,1944.040039,1946.040039,1948,1950,1952,1954,1956,1957.959961,1960,1962,1963.959961,1966,1968,1970.040039,1972.040039,1974.040039,1976.079956,1978.040039,1980,1982,1983.959961,1985.959961,1987.959961,1989.959961,1992,1994,1996.040039,1998.079956,2000.040039,2002.040039,2004.079956,2005.599976],[35.000999,35.087002,35.189999,35.268002,35.335999,35.432999,35.592999,35.765999,35.798,35.807999,35.827999,35.838001,35.841999,35.845001,35.847,35.847,35.847,35.848,35.848999,35.851002,35.852001,35.852001,35.851002,35.848999,35.848,35.84,35.830002,35.825001,35.852001,36.037998,36.030998,35.952999,35.925999,35.866001,35.806999,35.776001,35.765999,35.733002,35.729,35.727001,35.721001,35.713001,35.708,35.702999,35.699001,35.685001,35.682999,35.681999,35.681,35.678001,35.674,35.666,35.660999,35.653,35.643002,35.632999,35.624001,35.617001,35.605999,35.594002,35.577999,35.57,35.563,35.553001,35.539001,35.537998,35.537998,35.537998,35.536999,35.536999,35.535999,35.533001,35.527,35.519001,35.512001,35.505001,35.501999,35.495998,35.487,35.477001,35.472,35.466,35.464001,35.460999,35.455002,35.450001,35.445,35.439999,35.436001,35.433998,35.433998,35.43,35.426998,35.425999,35.425999,35.425999,35.425999,35.424,35.421001,35.417999,35.414001,35.409,35.405998,35.402,35.400002,35.396999,35.394001,35.389999,35.383999,35.380001,35.375,35.369999,35.367001,35.363998,35.360001,35.359001,35.356998,35.355,35.353001,35.353001,35.352001,35.351002,35.347,35.344002,35.342999,35.341999,35.34,35.339001,35.338001,35.337002,35.334,35.330002,35.326,35.321999,35.317001,35.311001,35.300999,35.297001,35.292,35.289001,35.287998,35.285999,35.285,35.284,35.282001,35.278999,35.271999,35.258999,35.250999,35.245998,35.240002,35.237999,35.235001,35.231998,35.228001,35.223,35.215,35.210999,35.203999,35.194,35.174999,35.168999,35.158001,35.153,35.150002,35.147999,35.146,35.143002,35.139,35.132999,35.126999,35.119999,35.115002,35.110001,35.101002,35.091,35.083,35.070999,35.061001,35.042999,35.035999,35.028,35.02,35.005001,34.999001,34.992001,34.987,34.981998,34.974998,34.970001,34.966,34.960999,34.955002,34.951,34.945999,34.939999,34.928001,34.918999,34.910999,34.903999,34.901001,34.896999,34.889999,34.884998,34.874001,34.865002,34.861,34.854,34.849998,34.847,34.842999,34.837002,34.831001,34.828999,34.826,34.820999,34.813999,34.810001,34.805,34.803001,34.799999,34.791,34.785999,34.785,34.789001,34.791,34.792999,34.793999,34.791,34.786999,34.785,34.777,34.771999,34.768002,34.759998,34.754002,34.752998,34.75,34.743999,34.737999,34.729,34.722,34.713001,34.707001,34.698002,34.695999,34.700001,34.702999,34.705002,34.708,34.705002,34.696999,34.691002,34.691002,34.688999,34.687,34.685001,34.681,34.675999,34.671001,34.667,34.666,34.666,34.665001,34.662998,34.66,34.657001,34.653999,34.653999,34.653999,34.653999,34.653999,34.652,34.646999,34.646999,34.646,34.645,34.643002,34.640999,34.639999,34.639999,34.636002,34.632,34.627998,34.626999,34.625999,34.625,34.624001,34.622002,34.620998,34.619999,34.618999,34.617001,34.616001,34.615002,34.613998,34.613998,34.612,34.612,34.611,34.611,34.610001,34.609001,34.606998,34.603001,34.601002,34.597,34.596001,34.594002,34.594002,34.592999,34.594002,34.594002,34.591999,34.587002,34.584,34.583,34.581001,34.577999,34.577999,34.577,34.576,34.576,34.574001,34.573002,34.573002,34.571999,34.574001,34.573002,34.573002,34.573002,34.573002,34.569,34.569,34.568001,34.567001,34.566002,34.563999,34.560001,34.555,34.553001,34.551998,34.551998,34.551998,34.556999,34.556,34.549999,34.546001,34.542999,34.539001,34.535999,34.533001,34.532001,34.530998,34.529999,34.529999,34.528999,34.528999,34.528999,34.528,34.527,34.528,34.526001,34.525002,34.526001,34.526001,34.525002,34.526001,34.525002,34.522999,34.522999,34.522999,34.522999,34.523998,34.526001,34.527,34.527,34.528,34.529999,34.532001,34.534,34.539001,34.537998,34.536999,34.537998,34.539001,34.539001,34.540001,34.542,34.542,34.544998,34.547001,34.549,34.550999,34.553001,34.554001,34.555,34.555,34.555,34.556,34.555,34.555,34.555,34.555,34.555,34.555,34.555,34.555,34.555,34.555,34.554001,34.554001,34.553001,34.553001,34.551998,34.549,34.547001,34.549,34.549999,34.550999,34.548,34.546001,34.550999,34.557999,34.567001,34.574001,34.575001,34.576,34.577,34.577999,34.577999,34.577999,34.580002,34.582001,34.584,34.585999,34.588001,34.589001,34.589001,34.591999,34.595001,34.596001,34.598999,34.598,34.598,34.598,34.596001,34.591999,34.591,34.591999,34.592999,34.594002,34.594002,34.595001,34.596001,34.598,34.598999,34.599998,34.601002,34.603001,34.604,34.604,34.605,34.608002,34.608002,34.609001,34.609001,34.609001,34.609001,34.611,34.612999,34.617001,34.622002,34.623001,34.623001,34.623001,34.623001,34.625,34.625999,34.631001,34.632999,34.633999,34.632999,34.633999,34.636002,34.637001,34.639999,34.640999,34.645,34.646,34.646999,34.647999,34.647999,34.647999,34.648998,34.648998,34.651001,34.653,34.66,34.662998,34.664001,34.665001,34.666,34.666,34.667,34.667999,34.668999,34.674,34.676998,34.678001,34.68,34.682999,34.683998,34.685001,34.686001,34.688,34.691002,34.694,34.696999,34.698002,34.699001,34.700001,34.701,34.701,34.702,34.703999,34.705002,34.708,34.708,34.709,34.709,34.709999,34.709999,34.710999,34.712002,34.719002,34.723,34.724998,34.727001,34.728001,34.73,34.730999,34.731998,34.733002,34.735001,34.737,34.740002,34.740002,34.741001,34.742001,34.743999,34.745998,34.745998,34.747002,34.75,34.754002,34.757,34.759998,34.762001,34.764,34.765999,34.766998,34.766998,34.769001,34.773998,34.776001,34.778999,34.779999,34.778999,34.778999,34.780998,34.783001,34.786999,34.787998,34.789001,34.792,34.792,34.793999,34.794998,34.799,34.801998,34.804001,34.805,34.805,34.807999,34.810001,34.813999,34.817001,34.819,34.82,34.821999,34.825001,34.830002,34.833,34.834,34.835999,34.839001,34.841999,34.842999,34.845001,34.848999,34.854,34.855,34.856998,34.859001,34.862999,34.867001,34.868,34.869999,34.872002,34.874001,34.875999,34.875999,34.876999,34.876999,34.876999,34.877998,34.881001,34.884998,34.887001,34.887001,34.888,34.888,34.888,34.888,34.889,34.890999,34.894001,34.895,34.895,34.895,34.896,34.896999,34.897999,34.897999,34.897999,34.898998,34.900002,34.900002,34.900002,34.901001,34.901001,34.901001,34.902,34.903,34.904999,34.907001,34.907001,34.908001,34.908001,34.908001,34.909,34.91,34.911999,34.915001,34.916,34.917,34.917999,34.921001,34.923,34.924,34.924,34.923,34.922001,34.921001,34.921001,34.919998,34.919998,34.919998,34.919998,34.919998,34.919998,34.919998,34.919998,34.918999,34.918999,34.921001,34.922001,34.924,34.924,34.924,34.925999,34.926998,34.926998,34.926998,34.926998,34.926998,34.926998,34.926998,34.928001,34.929001,34.93,34.931,34.931,34.931,34.931999,34.932999,34.933998,34.935001,34.935001,34.936001,34.938,34.939999,34.942001,34.941002,34.939999,34.941002,34.941002,34.941002,34.941002,34.941002,34.944,34.945999,34.945999,34.946999,34.948002,34.952,34.952999,34.952999,34.953999,34.952999,34.952999,34.952999,34.953999,34.956001,34.956001,34.957001,34.958,34.959,34.959999,34.959999,34.959999,34.959,34.959999,34.959999,34.960999,34.960999,34.962002,34.963001,34.964001,34.963001,34.963001,34.960999,34.960999,34.960999,34.960999,34.960999,34.960999,34.960999,34.960999,34.962002,34.963001,34.963001,34.962002,34.962002,34.962002,34.963001,34.965,34.964001,34.964001,34.963001,34.963001,34.964001,34.964001,34.965,34.965,34.965,34.965,34.965,34.965,34.965,34.966,34.966,34.966,34.966,34.966,34.966,34.966,34.966,34.966,34.966,34.966999,34.966999,34.966999,34.966999,34.966999,34.966999,34.967999,34.969002,34.969002,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.971001,34.971001,34.971001,34.971001,34.971001,34.971001,34.971001,34.971001,34.971001,34.971001,34.972,34.972,34.972,34.972,34.972,34.972,34.972,34.973,34.973,34.973,34.973,34.973,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.974998,34.973999,34.974998,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.974998,34.974998,34.974998,34.976002,34.976002,34.976002,34.976002,34.976002,34.976002,34.976002,34.974998,34.974998,34.976002,34.978001,34.978001,34.978001,34.977001,34.976002,34.976002,34.976002,34.974998,34.974998,34.974998,34.974998,34.974998,34.976002,34.976002,34.976002,34.976002,34.977001,34.976002,34.976002,34.976002,34.976002,34.976002,34.976002,34.976002,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.974998,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973999,34.973,34.973,34.973,34.973,34.973,34.973,34.972,34.972,34.972,34.971001,34.971001,34.971001,34.971001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.970001,34.969002,34.969002,34.969002,34.969002,34.969002,34.969002,34.969002,34.969002,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.967999,34.966999,34.966999,34.966999,34.966999,34.966999,34.966999,34.966999,34.966999,34.966999,34.966,34.966,34.966,34.966,34.966,34.966,34.965,34.965,34.965,34.965],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],"data_info":[["temperature","pressure","salinity","temperature_argoqc","pressure_argoqc","salinity_argoqc"],["units","data_keys_mode"],[["degree_Celsius","R"],["decibar","R"],["psu","R"],[None,None],[None,None],[None,None]]],"metadata":["1902305_m0"]}

        mock_data = [profile, copy.deepcopy(profile), copy.deepcopy(profile)] # dupe profile for downsampling
        mock_data[0]['geolocation'] = {"type":"Point","coordinates":[-27.4493,2.32012]} # original, unchanged for reference
        mock_data[1]['geolocation'] = {"type":"Point","coordinates":[-27.4493,2.33012]} # <0.1 degree too close, should get downsampled out
        mock_data[2]['geolocation'] = {"type":"Point","coordinates":[-27.4493,2.44012]} # >0.1 degree far enough, should survive downsampling
        with open(input_path, "w") as f:
            json.dump(mock_data, f)

        # 1. argovis_input.py
        selectionfile = os.path.join(tmpdir, "argovis_selection.json")
        result = subprocess.run(
            ["python", "argovis_input.py", "--data_dir", tmpdir, "--year", "2025", "--month", "5", "--output_file", selectionfile, "--pressure_qc", "1,2", "--temperature_qc", "1,2", "--salinity_qc", "1,2"],
            capture_output=True,
            text=True,
        )
        assert result.returncode == 0, f"Script failed:\n{result.stderr}"

        munged_input_file = glob.glob(selectionfile)
        df = pd.read_parquet(munged_input_file[0])
        assert df["juld"].iloc[0] == 739750.1796412037
        assert df["latitude"].iloc[0] == 2.32012 
        assert df["longitude"].iloc[0] == 360-27.4493
        assert df["float"].iloc[0] == 1902305
        assert df["cycle"].iloc[0] == '128'
        assert df["filetype"].iloc[0] == 'argovis'
        assert numpy.array_equal(df["temperature"].iloc[0][0:5], [28.973,29.006001,29.028999,29.062,29.112])
        assert numpy.array_equal(df["pressure"].iloc[0][0:5], [1.04,1.96,3,4.04,5.08])
        assert numpy.array_equal(df["salinity"].iloc[0][0:5], [35.000999,35.087002,35.189999,35.268002,35.335999])
        assert numpy.array_equal(df["temperature_qc"].iloc[0][0:5], [1,1,1,1,1])
        assert numpy.array_equal(df["pressure_qc"].iloc[0][0:5], [1,1,1,1,1])
        assert numpy.array_equal(df["salinity_qc"].iloc[0][0:5], [1,1,1,1,1])

        # 2. variable_creation.py
        variable_creation_out = os.path.join(tmpdir, "potential_temperature.parquet")
        result = subprocess.run(
            ["python", "variable_creation.py", "--input_file", selectionfile, "--variable", "potential_temperature", "--output_file", variable_creation_out],
            capture_output=True,
            text=True,
        )
        assert result.returncode == 0, f"Script failed:\n{result.stderr}"
        variable_creation = glob.glob(variable_creation_out)
        df = pd.read_parquet(variable_creation[0])
        index = 5 # spot check a calculated absolute salinity and potential temperature
        pressure = df["pressure"].iloc[0][index]
        temperature = df["temperature"].iloc[0][index]
        salinity = df["salinity"].iloc[0][index]
        longitude = df["longitude"].iloc[0]
        latitude = df["latitude"].iloc[0]
        absolute_salinity = gsw.conversions.SA_from_SP(salinity, pressure, longitude, latitude)
        potential_temperature = gsw.conversions.pt0_from_t(absolute_salinity, temperature, pressure)
        assert numpy.allclose(df["potential_temperature"].iloc[0][index], potential_temperature)
        assert numpy.allclose(df["absolute_salinity"].iloc[0][index], absolute_salinity)

        # 3a. interpolate.py
        interpolate_out = os.path.join(tmpdir, "interpolated.parquet")
        result = subprocess.run(
            ["python", "interpolate.py", "--input_file", variable_creation_out, "--output_file", interpolate_out, "--level", "5.5", "--variable", "potential_temperature"],
            capture_output=True,
            text=True,
        )
        assert result.returncode == 0, f"Script failed:\n{result.stderr}"
        interpolate = glob.glob(interpolate_out)
        df = pd.read_parquet(interpolate[0])
        ## pipeline should track pchip interpolation
        interp = scipy.interpolate.PchipInterpolator(df["pressure"].iloc[0], df["potential_temperature"].iloc[0], extrapolate=False)([5.5])
        assert numpy.allclose(interp, df["potential_temperature_interpolation"].iloc[0], equal_nan=True)

        # 3b. integrate.py
        integrate_out = os.path.join(tmpdir, "integrated.parquet")
        result = subprocess.run(
            ["python", "integrate.py", "--input_file", variable_creation_out, "--output_file", integrate_out, "--variable", "potential_temperature", "--region", "5,10"],
            capture_output=True,
            text=True,
        )
        assert result.returncode == 0, f"Script failed:\n{result.stderr}"
        integrate = glob.glob(integrate_out)
        df = pd.read_parquet(integrate[0])
        # basic integration stability check
        assert numpy.allclose(df["potential_temperature_integration"].iloc[0], [1512.0568956])
        assert df.shape[0] == 3, "still three profiles at this point in the pipeline"
  
        # 4. downsample.py
        downsample_out = os.path.join(tmpdir, "downsampled.parquet")
        result = subprocess.run(
            ["python", "downsample.py", "--input_file", integrate_out, "--output_file", downsample_out],
            capture_output=True,
            text=True,
        )
        assert result.returncode == 0, f"Script failed:\n{result.stderr}"
        downsample = glob.glob(downsample_out)
        df = pd.read_parquet(downsample[0])
        # basic downsample check
        assert df.shape[0] == 2, "Downsampled file should have only two rows left"

        # 5. matlab_convert.py
        matlab_out = os.path.join(tmpdir, "converted.mat")
        result = subprocess.run(
            ["python", "matlab4localgp.py", "--input_file", downsample_out, "--output_file", matlab_out, "--variable", "potential_temperature_integration"],
            capture_output=True,
            text=True,
        )
        assert result.returncode == 0, f"Script failed:\n{result.stderr}"
        matlab_convert = glob.glob(matlab_out)
        mat = scipy.io.loadmat(matlab_convert[0])
        # basic matlab conversion check
        assert numpy.allclose(mat['profVariableAggrMonth'][0][0], 1512.0568956)
        assert numpy.allclose(mat['profLatAggrMonth'][0][0], 2.32012)
        assert numpy.allclose(mat['profLongAggrMonth'][0][0], 360-27.4493)
        assert numpy.allclose(mat['profFloatIDAggrMonth'][0][0], 1902305)
        assert mat['profObsIDAggrMonth'][0] == '128'
        assert numpy.allclose(mat['profJulDayAggrMonth'][0][0], 739750.1796412037)

    finally:
        # Clean up manually (since mkdtemp doesn't auto-delete)
        shutil.rmtree(tmpdir)
















